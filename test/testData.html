<!DOCTYPE html><!-- the html head is genereated by  "emmet Abbreviate" VS Code extension-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test data.js</title>
</head>
<body>
    <script src="../js/data.js"></script>
    <script src="../resource/d3.v6.min.js"></script>
    <script>
        const parseTime = d3.timeParse("%Y/%m/%d %H:%M");
        const MINUTE = 60;
        const HOUR = 60 * MINUTE;
        const DAY = 24 * HOUR;
        let data;
        let timeSeriesData;
        
        d3.csv("../data/data_long.csv").then(function (d) {
            data = d;
            data.forEach(function (d) {
                d.time = parseTime(d.time);
                d.damage_value = +d.damage_value;
            });
            console.log(data);
            timeSeriesData = new TimeSeriesData(data, "time", "damage_value");
            if (testCountAgg(data, timeSeriesData)) {
                console.log("testCountAgg passed");
            } else {
                console.log("testCountAgg failed");
            }
            if (testMeanAgg(data, timeSeriesData)) {
                console.log("testMeanAgg passed");
            } else {
                console.log("testMeanAgg failed");
            }
        });
        function testCountAgg(data, timeSeriesData) {
            // test if the count are the same for different interval
            let dataLen = data.length;
            let intervalData30min = timeSeriesData.getDataAggregatedByInterval(30*MINUTE, new CountAggregator());
            let sum30min = intervalData30min.reduce((a, b) => a + b.value, 0);
            let intervalData4hrs = timeSeriesData.getDataAggregatedByInterval(4*HOUR, new CountAggregator());
            let sum4hrs = intervalData4hrs.reduce((a, b) => a + b.value, 0);
            let intervalData1day = timeSeriesData.getDataAggregatedByInterval(DAY, new CountAggregator());
            let sum1day = intervalData1day.reduce((a, b) => a + b.value, 0);
            let passed = []
            console.log("dataLen:" + dataLen ,"sum30min: " + sum30min + " sum4hrs: " + sum4hrs + " sum1day: " + sum1day)
            if (sum30min == dataLen) {
                passed.push(true);
            } else {
                passed.push(false);
            }
            if (sum4hrs == dataLen) {
                passed.push(true);
            } else {
                passed.push(false);
            }
            if (sum1day == dataLen) {
                passed.push(true);
            } else {
                passed.push(false);
            }
            return passed.reduce((a, b) => a && b, true);
        }
        function testMeanAgg(data, timeSeriesData) {
            // test if the mean*length are the same for different intervalLength
            let dataTotalDamage = data.reduce((a, b) => a + b.damage_value, 0);
            let intervalData30min = timeSeriesData.getDataAggregatedByInterval(30*MINUTE, new MeanAggregator());
            let intervalData30minCount = timeSeriesData.getDataAggregatedByInterval(30*MINUTE, new CountAggregator());
            let intervalData4hrs = timeSeriesData.getDataAggregatedByInterval(4*HOUR, new MeanAggregator());
            let intervalData4hrsCount = timeSeriesData.getDataAggregatedByInterval(4*HOUR, new CountAggregator());
            let intervalData1day = timeSeriesData.getDataAggregatedByInterval(DAY, new MeanAggregator());
            let intervalData1dayCount = timeSeriesData.getDataAggregatedByInterval(DAY, new CountAggregator());
            let sum30min = 0;
            let sum4hrs = 0;
            let sum1day = 0;
            for (let i = 0; i < intervalData30min.length; i++) {
                sum30min += intervalData30min[i].value * intervalData30minCount[i].value;
            }
            for (let i = 0; i < intervalData4hrs.length; i++) {
                sum4hrs += intervalData4hrs[i].value * intervalData4hrsCount[i].value;
            }
            for (let i = 0; i < intervalData1day.length; i++) {
                sum1day += intervalData1day[i].value * intervalData1dayCount[i].value;
            }
            let passed = []
            console.log("dataTotalDamage:" + dataTotalDamage ,"sum30min: " + sum30min + " sum4hrs: " + sum4hrs + " sum1day: " + sum1day)
            if (sum30min == dataTotalDamage) {
                passed.push(true);
            } else {
                passed.push(false);
            }
            if (sum4hrs == dataTotalDamage) {
                passed.push(true);
            } else {
                passed.push(false);
            }
            if (sum1day == dataTotalDamage) {
                passed.push(true);
            } else {
                passed.push(false);
            }
            return passed.reduce((a, b) => a && b, true);
        }
    </script>
</body>
</html>